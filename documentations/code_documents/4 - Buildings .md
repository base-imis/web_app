Version: V1.0.0

# Building IMS

## Buildings

### Tables

The Building Module uses the following tables

-   buildings: stores primary information of the building
-   building_surveys: stores survey information received from the mobile application
-   build_contains: relational database that connects buildings and containments. Foreign Key: bin and containment_id.
-   owners: relational database that connects buildings and their owner. Foreign_key: bin
-   functional_uses: stores functional use attributes used as dropdowns
-   sanitation_systems: stores sanitation system types attributes used as dropdowns
-   use_categorys: stores Use categorys attributes used as dropdowns
-   water_sources: stores Water sources attributes used as dropdowns
-   wms_links: stores links for WMS (geoserver)

The corresponding tables have their respective models that are named in Pascal Case in singular form. The containment info modules are located at app\\Http\\Models.

### Views

All views used by this module is stored in resources\\views\\building-info\\building

-   building. create: opens form and calls partial-form for form content
-   building.edit.blade: opens form and calls partial-form for form contents
-   building.history: lists all past edits of the record
-   building.index: lists containments records
-   building.partial-form: creates form content for addition of new containment or edit containment of existing building
-   building.show: displays all attributes of particular record

### Models

Location: app\\Models\\BuildingInfo\\Building.php

There are multiple relationships defined in the Building Model. They are:

-   containments: belongsToMany relationship (n to n relationship)
-   sharedToilets: belongsToMany relationship with PTCT ((n to n relationship)
-   Owners: belongsTo relationship (1 to 1 relationship)
-   StructureType: belongsTo relationship (1 to 1 relationship)
-   Applications: hasMany relationship (1 to n relationship)
-   Roadlines: belongsTo relationship (1 to 1 relationship)
-   functionalUse: belongsTo relationship with PTCT ((n to n relationship)
-   useCategory: belongsTo relationship (1 to 1 relationship)
-   sanitationSystemTypes: belongsTo relationship (1 to 1 relationship)
-   sanitationSystemTechnology: belongsTo relationship (1 to 1 relationship)
-   ctpt: belongsTo relationship (1 to 1 relationship)

Location: app\\Models\\BuildingInfo\\Owner.php

There are multiple relationships defined in the Owner Model. They are:

-   Buildings: hasMany relationship (1 to n relationship)

### BuildingController

Controller: app\\Http\\Controllers\\BuildingInfo\\BuildingController.php

The controller’s main function is to provide the connection between the calling route and its subsequent function written in the Service Class.

The basic classes of the controller are:

| Function    | \__construct()                                                         |
|-------------|------------------------------------------------------------------------|
| Description | Initializes authentication, permissions and the service class instance |
| Parameters  | Service class instance(BuildingStructureService)                       |
| Return      | null                                                                   |
| Source      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php           |

| Function    | getData ()                                                                                                   |
|-------------|--------------------------------------------------------------------------------------------------------------|
| Description | Calls the service class that handles the process of CRUD of buildings according to users role and permission |
| Parameters  | Service class instance(fetchData)                                                                            |
| Return      | null                                                                                                         |
| Source      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                                                 |

| **Function**    | index()                                                                      |
|-----------------|------------------------------------------------------------------------------|
| **Description** | Returns the index.blade.php page with dropdown values fetched from database. |
| **Parameters**  | null                                                                         |
| **Return**      | building-info.building.index compact('page_title')                           |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                 |

| Function    | create()                                                                                                                                                                                                                                                                                                        |
|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Description | Returns the form to create new building with dropdown values fetched from the database.                                                                                                                                                                                                                         |
| Parameters  | null                                                                                                                                                                                                                                                                                                            |
| Return      |  return view('building-info.buildings.create', compact(  'page_title',  'bin',  'containment_id',  'water_source',  'structure_type',  'functional_use',  'usecatgsJson',  'sanitation_system_technology',  'containment',  'road_code',  'ward',  'buildingSurvey',  'sewer_code',  'ctpt',  'drain_code'  ))  |
| Source      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                                                                                                                                                                                                                                                    |
| Remarks     | function handles the situation where building is created by associating it with a containment .                                                                                                                                                                                                                 |

| **Function**    | store()                                                                   |
|-----------------|---------------------------------------------------------------------------|
| **Description** | Calls the service class that handles the process of storing Building data |
| **Parameters**  | BuildingRequest \$request                                                 |
| **Return**      | Success or error message.                                                 |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php              |
| **Remarks**     | storeBuildingData(\$request)                                              |

| **Function**    | show()                                                                           |
|-----------------|----------------------------------------------------------------------------------|
| **Description** | Returns the page displaying individual Building data                             |
| **Parameters**  | \$id                                                                             |
| **Return**      | building-info.buildings.show  compact('page_title', 'building', 'containment'))  |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                     |

| **Function**    | edit()                                                                                                                                                                                                                                                                                                                                                                                                 |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Returns the edit form page displaying pre-existing individual Building data                                                                                                                                                                                                                                                                                                                            |
| **Parameters**  | \$id                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Return**      | building-info.buildings.edit compact(  'page_title',  'building',  'bin',  'containment_id',  'sanitation_system_types',  'water_source',  'structure_type',  'functional_use',  'usecatgsJson',  'containment',  'sub_typeJson',  'sanitation_system_technology',  'containment',  'road_code',  'ward',  'buildingSurvey',  'sewer_code',  'ctpt',  'build_toilet_id',  'ctpt_ids',  'drain_code' )  |
| **Source**      | app\\Http\\Controllers\\Fsm\\ContainmentController.php                                                                                                                                                                                                                                                                                                                                                 |

| **Function**    | update()                                                                   |
|-----------------|----------------------------------------------------------------------------|
| **Description** | Calls the service class that handles the process of updating Building data |
| **Parameters**  | BuildingRequest \$request , \$id                                           |
| **Return**      | Success or error message.                                                  |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php               |
| Remarks         | updateBuildingData                                                         |

| **Function**    | history()                                                      |
|-----------------|----------------------------------------------------------------|
| **Description** | Shows all buildings records that have been edited              |
| **Parameters**  | \$id                                                           |
| **Return**      | Success or error message.                                      |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php   |

| **Function**    | destroy()                                                      |
|-----------------|----------------------------------------------------------------|
| **Description** | Soft deletes Building information .                            |
| **Parameters**  | \$id                                                           |
| **Return**      |                                                                |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php   |
| **Remarks**     |                                                                |

| **Function**    | export()                                                                    |
|-----------------|-----------------------------------------------------------------------------|
| **Description** | Calls the service class that handles the process of exporting Building data |
| **Parameters**  |                                                                             |
| **Return**      | CSV file containing containment data                                        |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                |
| **Remarks**     | fetchExport  (service class function)                                       |

| **Function**    | getHouseNumbers()                                                                                           |
|-----------------|-------------------------------------------------------------------------------------------------------------|
| **Description** | Calls the service class that handles building based on search criteria such as road code and search string  |
| **Parameters**  |                                                                                                             |
| **Return**      | fetchHouseNumber(service class function)                                                                             |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                                                |

| **Function**    | listContainments                                               |
|-----------------|----------------------------------------------------------------|
| **Description** | Disconnects the relation between the containment and building. |
| **Parameters**  | \$id, \$bin                                                    |
| **Return**      |  \$title,\$popContentsHtml                                     |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php   |
| **Remarks**     |                                                                |

| **Function**    | getHouseNumbersAll()                                                                 |
|-----------------|--------------------------------------------------------------------------------------|
| **Description** | Calls the service class that handles returns json with building id and house numebr  |
| **Parameters**  |                                                                                      |
| **Return**      | Returns a JSON response with building id and house number                            |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                         |

| **Function**    | listContainments                                               |
|-----------------|----------------------------------------------------------------|
| **Description** | Disconnects the relation between the containment and building. |
| **Parameters**  | \$id, \$bin                                                    |
| **Return**      |  \$title,\$popContentsHtml                                     |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php   |
| **Remarks**     |                                                                |

| **Function**    | popUpContentHtml                                                                                                                                                                       |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Creates a HTML table displaying containment records , builds the table header and body .It iterates through the containment array adding rows and containment id type and view button. |
| **Parameters**  | \$containments                                                                                                                                                                         |
| **Return**      |  Returns HTML table                                                                                                                                                                    |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php                                                                                                                           |
| **Remarks**     |                                                                                                                                                                                        |

| **Function**    | getContainmentTypes                                            |
|-----------------|----------------------------------------------------------------|
| **Description** | Disconnects the relation between the containment and building. |
| **Parameters**  | \$id, \$bin                                                    |
| **Return**      |  \$title,\$popContentsHtml                                     |
| **Source**      | app\\Http\\Controllers\\BuildingInfo\\BuildingController.php   |
| **Remarks**     |                                                                |

### BuildingStructureService

Location: app\\Services\\BuildingInfo\\BuildingStructureService.php

The Service Class contains all the business logic. It contains all the functions that are being called in the BuildingController.

| **Function**    | storeBuildingData(Request \$request)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | This function creates a new building record in the database, populating it with data from the request. It handles various attributes such as ownership, sanitation systems, and population details, and ensures proper validation and keyword matching for specific fields. It also manages transactional integrity, rolling back in case of errors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Parameters**  | \$request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Return**      | Returns data of containment table for datatables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Source**      | app\\Services\\BuildingInfo\\BuildingStructureService.php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Logic**       | Begins transaction, to mark the start. Used to rollback if save fails Fetches max bin from building table and removes B  Creates new model for building Calculates new bin number by adding 1 and concatenates B to the beginning  Stores information that has been submitted to respective building fields Dynamic Conditions: Check if the building is not a main building and set the building_associated_to attribute accordingly. Check if the building is not residential and set the office_business_name attribute accordingly. Check if the building is a low-income household and, if so, check the LIC (Low Income Community) status to set the lic_id attribute. Check if the water source is non-municipal and set the water_customer_id and watersupply_pipe_code attributes accordingly. Check if there is a well present and set the distance_from_well attribute accordingly. Check if the toilet status is false and set the sanitation_system_id to the defecation place. If the toilet status is true, set attributes like toilet_count, no_hh_shared_toilet, population_shared_toilet, and sanitation_system_id. Check for keywords in the sanitation system to set the sewer_code or drain_code. Check if the sanitation system contains the keyword "shared" and call storeContainmentInfo with the appropriate flag. Check if the sanitation system contains the keywords "septic" or "pit" without "shared" and call storeContainmentInfo accordingly. Check if the sanitation system contains the keywords "drain", "sewer", "onsite", "water", "ground", or "composting" to determine if no containment info needs to be stored. Check if the sanitation system contains the keyword "community" and call storeContainmentInfo with the appropriate flag.  |
| **Remarks**     | This                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

| **Function**    | storeContainmentInfo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the storage and updating of containment information for buildings, including communal, shared, and specific containment types like septic tanks and holding tanks. It updates or creates records in the Containment and BuildToilet models and ensures the correct relationships and attributes are set based on the provided request data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Parameters**  |  flag (string): Indicates the type of containment ('communal', 'shared', or 'containment').  type (string): Specifies the operation type ('create', 'createContainOnly', or 'update').  request (Request object): Contains the request data with various building and containment attributes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Return**      |  For 'shared' containment: Returns the sanitation system ID of the related building.  For other containment types: No explicit return value, but the function performs database updates and commits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Source**      | app\\Services\\ BuildingInfo\\BuildingStructureService.php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Logic**       |  **Communal or Shared Containment:** **Communal:** If type is 'update', removes the previous BuildToilet connection if it exists. Creates a new BuildToilet record to store the connection between the building and the communal toilet. **Shared:** Finds the related building and its containment ID. Calls storeBuildContainInfo to store the building-containment relationship. Returns the sanitation system ID of the related building.  **Specific Containment Types (e.g., Septic Tanks, Holding Tanks):** **Create or CreateContainOnly:** Generates a new containment ID. **Update:** Finds the existing containment record using the provided ID. Sets various attributes for the containment based on the request data, including type, dimensions, and criteria. **Septic Tanks:** Updates connected buildings with sewer and drain codes. **Holding Tanks:** Sets dimensions based on the shape (rectangular or cylindrical). Sets additional containment attributes such as construction date and location. Handles geometric data (geom) for the containment: For 'createContainOnly', sets geom from the building's centroid. For other types, calls storeGeomInfo to set geom. Saves the containment record. Calls storeBuildContainInfo to store the building-containment relationship. Commits the database transaction.  |
| **Remarks**     | This                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

| **Function**    | storeOwnerInfo(\$request, \$type)                                                                                                                                                                                                     |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Stores (bin , tax_code) or Updates (name , gender , contact)building owner detail                                                                                                                                                     |
| **Parameters**  | \$request , \$type                                                                                                                                                                                                                    |
| **Return**      | Success or error message, stores data to containments.                                                                                                                                                                                |
| **Source**      | app\\Services\\ BuildingInfo\\BuildingStructureService.php                                                                                                                                                                            |
| **Logic**       | \$type determines the operation is create or update If type is create, the function creates a new Owner Instance. if type is update, the function updates the existing owner instance based on bin (Building Identification Number)   |

| **Function**    | storeBuildContainInfo(\$bin, \$containment_id)                                                                                                                                                                                                                                                                                                |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Stores a relation between building and containment                                                                                                                                                                                                                                                                                            |
| **Parameters**  | \$bin, \$containment_id                                                                                                                                                                                                                                                                                                                       |
| **Return**      |                                                                                                                                                                                                                                                                                                                                               |
| **Source**      | app\\Services\\BuildingInfo\\BuildingStructureService.php                                                                                                                                                                                                                                                                                     |
| **Logic**       | Creates a new instance of the 'BuildContain' model representing relationship between building and containment. It sets the bin attribute of the BuildContain instance to the provided \$bin. It sets the containment_id attribute of the BuildContain . Save the instance to establish the relationship between the building and containment. |

| **Function**    | storeGeomInfo(\$request , \$flag , \$type)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the process of storing geom information by converting kml into geom                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Parameters**  | \$request: contains the form fields \$flag: defines the type of store, either create or update \$type: defines type of calculations to be carried out; Values: building, containment or area                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Return**      | Return geom of building if flag is set as building, centroid of geom if flag is set as containment and area of geom is flag is set as area                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Source**      | app\\Services\\Fsm\\ContainmentService.php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Logic**       | Checks if type is create or update: If create; If geom (KML File) is present, it converts it into a new DOM Document and load the kml file into xml form. If \$request-\>kml exits, that means the building is being added via building survey, thus the kml file is fetched from the server and converted into xml. If update; Checks if request-\>geom is present, and loads it into xml if it is present, else throws error The xml file is converted into coordinate values and stored in points Checks if flag is building, area or containment: If flag is building; The points are converted into geom If flag is area; The area is calculated via the points generated If flag is containment; The centroid of the geom is calculated |

| **Function**    | updateBuildingData(\$request, \$id)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Updates building information based on the request data, including handling various sanitation systems, containment relationships, and geometric information. It performs validation checks and ensures consistency of the data. If there is a mismatch in the containment and sanitation system, it rolls back the transaction and returns an error message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Parameters**  | \$request, \$id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Return**      | Redirects to the building information page with a success message if the update is successful. Redirects back with an error message if there is a containment mismatch or if the update fails.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Source**      | app\\Services\\BuildingInfo\\BuildingStructureService.php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Logic**       |  **Begin Transaction:** Starts a database transaction.  **Find Building:** Finds the building by the given ID.  **Set Initial Error Flag:** Sets the error flag to "no_error".  **Update Building Attributes:** Updates various building attributes from the request data (e.g., ward, road_code, house_number, tax_code, etc.). Handles conditional updates based on specific criteria (e.g., main_building, functional_use_id, toilet_status).  **Update Population Information:** Updates population information (e.g., male, female, and other populations, including differently-abled populations).  **Update Income and Water Source Information:** Updates low-income household information and water source details.  **Handle Geometry and Area:** Updates the building's geometry and estimated area if a new geometry file is provided.  **Update User Information:** Sets the user ID of the user making the update.  **Store Owner Information:** Calls storeOwnerInfo to store owner-related information.  **Handle Sanitation Systems:** **Toilet Present:** Sets the sanitation system ID. Validates and updates containment relationships based on the sanitation system type. Handles different sanitation systems (e.g., shared septic tanks, septic or pit systems, sewer, drain, or other systems). **No Toilet Present:** Sets the sanitation system ID based on the defecation place. Handles containment relationships and updates based on the defecation place.  **Validation and Error Handling:** Rolls back the transaction and returns an error message if there is a containment mismatch. Proceeds if there are no errors.  **Save Building:** Saves the updated building information.  **Store Owner Information Again:** Calls storeOwnerInfo again to ensure owner information is stored.  **Commit Transaction:** Commits the transaction if everything is successful.  **Return Response:** Redirects to the building information page with a success message. Catches exceptions, rolls back the transaction, and returns an error message if the update fails. |

| **Function**    | updateBuildingFromContainment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the process of update building, owner information and containment,drain code or sewer code if any.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Parameters**  | \$request (mixed): This can be either a request object or a containment ID. It contains the data needed to find the containment and update the building's sanitation details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Return**      | void: This function does not return a value. It performs updates directly on the Building records in the database.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Source**      | app\\Services\\BuildingInfo\\BuildingStructureService.php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Logic**       |  **Fetch Containment:** Retrieve the containment record using the containment_id from the \$request or directly from the \$request.  **Update Buildings:** If the containment has associated buildings: Loop through each connected building. Fetch the building details. Assign a new sanitation system ID based on the containment's type. Set the toilet status to true. Update drain or sewer codes if the sanitation system or containment type includes specific keywords ("drain" or "sewer").  **Check Existing Containments:** For each building: Check if any associated containment has a drain or sewer connection. If no containment has a drain or sewer connection, set the respective codes to null.  **Save Changes:** Save the updated building details to the database. If err is set as no_containment, this means no containment connections are required to be set, so checks for existing containment connection. If count is not zero, it throws error and update is blocked. If err is set as shared, the function storeContainmentInfo is called that handles the containment addition process with respective flags If err is set as communal, the function storeContainmentInfo is called that handles the containment addition process with respective flags Tables Affected: buildings, build_contain, owners, containments, build_toilets. |

| **Function**    | fetchExport ()                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the process of exporting building and owner information                                                                                                                                                                                                                                                                                                                                                                         |
| **Parameters**  |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Return**      | Returns CSV                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Logic**       | \$bin = isset(\$_GET['bin']) ? \$_GET['bin'] : null; Fetching value on the basis of which filter is to be carried out. This value needs to be declared in the script of the index page. Define columns, and the query fetching the respective columns Check if any filter values are present, if yes, filter accordingly Set styles using StyleBuilding provided by Box/Spout\^2 Run query, store values in the columns Export the data |

| **Function**    | fetchHouseNumber()                                                                                                                                               |
|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the process of fetching house number for selection of address according to road code                                                                     |
| **Parameters**  |                                                                                                                                                                  |
| **Return**      | Returns data of building house number                                                                                                                            |
| **Logic**       | Runs query to fetch all buildings having containments Runs filter query to filter according to house number or road code Returns json response of house numbers  |

| **Function**    | fetchData()                                                                                                                                                                                                                                   |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Handles the process of fetching building and owner data for data tables                                                                                                                                                                       |
| **Parameters**  | \$request                                                                                                                                                                                                                                     |
| **Return**      | Returns data of building and owner table for datatables                                                                                                                                                                                       |
| **Logic**       | Join required tables Check for filter values if any. Filter accordingly.  Filter values are defined in the script of the index page Append actions column that contain buttons such as edit, delete, show, history and so on Return datatable |

| **Function**    | fetchHouseNumberAll ()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Fetches house number information from the Building model, with optional search and filtering functionality. It supports pagination and returns the results in JSON format, suitable for usage in APIs or web applications.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Parameters**  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Return**      | A JSON response containing the house number results and pagination information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Logic**       |  **Initialize Query:** Starts a query on the Building model, selecting all columns (\*) and filtering out deleted buildings and those associated with another building.  **Apply Search Filter:** Checks if a search term is provided in the request. If so, adds a filter to search within the bin and house_number columns using a case-insensitive ilike query.  **Apply Road Code Filter:** Checks if a road code is provided in the request. If so, filters the buildings by the specified road_code.  **Pagination Setup:** Counts the total number of results. Sets a limit of 10 results per page. Determines the current page from the request or defaults to page 1. Calculates the starting point for the query based on the current page. Calculates the total number of pages and determines if there are more results to paginate through.  **Fetch Paginated Results:** Offsets the query to start from the calculated starting point. Limits the number of results to the specified limit (10). Executes the query and fetches the results.  **Format Results:** Initializes an empty array for JSON results. Iterates over the fetched results, formatting each result as an associative array with id (set to bin) and text (set to house_number or bin if house_number is null).  **Return JSON Response:** Returns a JSON response containing the formatted results and pagination information, indicating if there are more results to fetch. Dynamic Conditions  **Search Condition:** If request()-\>search is present, it searches within the bin and house_number columns.  **Road Code Condition:** If request()-\>road_code is present, it filters results by the specified road_code.  **Pagination Condition:** Calculates the starting point and the number of pages based on the total number of results and the current page  |

### BuildingRequest

Location: app\\Http\\Requests\\BuildingInfo\\BuildingRequest.php)

BuildingRequest handles all validation login. It handles validation logic as well as error messages to be displayed.

| **Function**    | authorize()                                            |
|-----------------|--------------------------------------------------------|
| **Description** | Determines if user is authenticated or not             |
| **Parameters**  |                                                        |
| **Return**      | Returns true                                           |
| **Source**      | app\\Http\\Requests\\BuildingInfo\\BuildingRequest.php |

| **Function**    | message()                                                                                                                         |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Message to be displayed in case of validation error                                                                               |
| **Parameters**  |                                                                                                                                   |
| **Return**      | Return validation message                                                                                                         |
| **Source**      | app\\Http\\Requests\\BuildingInfo\\BuildingRequest.php                                                                            |
| **Remarks**     | Need to include errors.list.blade that displays the error message in dashboard Format: ‘Field.validation_rule’ =\>”error_message” |

| **Function**    | store()                                                                           |
|-----------------|-----------------------------------------------------------------------------------|
| **Description** | Contains validation rules for storing new building data                           |
| **Parameters**  |                                                                                   |
| **Return**      | Returns error if validation is not fulfilled, else returns true                   |
| **Remarks**     | Format for validation rule: ‘field_name’=\>’validation_rule1 \| validation_rule2’ |

| **Function**    | update()                                                                          |
|-----------------|-----------------------------------------------------------------------------------|
| **Description** | Contains validation rules for updaing building data                               |
| **Parameters**  |                                                                                   |
| **Return**      | Returns error if validation is not fulfilled, else returns true                   |
| **Remarks**     | Format for validation rule: ‘field_name’=\>’validation_rule1 \| validation_rule2’ |

building-surveys.index: lists building survey records(db: building_surveys).

### Building Surveys

### Tables

The Building Info Module uses the following tables:

-   building_surveys: stores survey information received from the mobile application

The corresponding tables have their respective models that are named in Pascal Case in singluar form. The building info modules are located at app\\Http\\Models\\BuildingInfo.

### Views

All views used by this module is stored in resources\\views\\building-info\\building-surveys

-   index: lists building records (db: buildings)
-   kmlPreviewModal: opens form and calls partial-form for form contents

### BuildingSurveyController

app\\Http\\Controllers\\BuildingInfo\\BuildingSurveyController.php

The controller’s main function is to provide the connection between the calling route and its subsequent function written in the Service Class.

The basic classes of the controller are:

| **Function**    | \__construct()                                                         |
|-----------------|------------------------------------------------------------------------|
| **Description** | Initializes authentication, permissions and the service class instance |
| **Parameters**  |                                                                        |
| **Return**      | null                                                                   |

| **Function**    | index()                                                                                                                                                                |
|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Returns the index.blade.php page  Called when Building Survey is selected from sidebar.blade.php via  \<a href="{{action('BuildingInfo\\BuildingController@index') }}" |
| **Parameters**  | null                                                                                                                                                                   |
| **Return**      | building-info.building-surveys.index compact('page_title')                                                                                                             |

| **Function**    | getData()                                                                                                                                                     |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Returns the data stored in building survey page which has is_enabled as true  Called when Building Survey’s index page is loaded via ajax call for datatable. |
| **Parameters**  | null                                                                                                                                                          |
| **Return**      | building-info.building-surveys.index compact('page_title')                                                                                                    |

| **Function**    | destroy ()                                   |
|-----------------|----------------------------------------------|
| **Description** | Soft deletes the building survey information |
| **Parameters**  | \$id                                         |
| **Return**      | Success or error message                     |
| **Remarks**     |                                              |

| **Function**    | download()                                                                 |
|-----------------|----------------------------------------------------------------------------|
| **Description** | Downloads the km file of the building survey that is stored in the server. |
| **Parameters**  |                                                                            |
| **Return**      | KML file containing building data                                          |

| **Function**    | approve()                                                                                                                                                                                                                                                   |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description** | Returns the add building page with the geom and building-survey field prefilled.                                                                                                                                                                            |
| **Parameters**  |                                                                                                                                                                                                                                                             |
| **Return**      | compact('page_title','bin','containment_id','sanitation_system_types', 'water_source','structure_type','functional_use','usecatgsJson','sub_typeJson','sanitation_system_technology','containment','road_code','ward','buildingSurvey','sewer_code','ctpt') |
| **Remarks**     | The building data added through approve button fetches the kml file from the database and stores the geom accordingly.                                                                                                                                      |
